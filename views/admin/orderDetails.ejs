<%- include('../layout/admin/adminHeader') -%>
<%- include('../layout/admin/adminNavbar') -%>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/sweetalert/1.1.3/sweetalert.min.css">

<div class="row">
    <div class="col-12 grid-margin stretch-card">
        <div class="card">
            <div class="card-body">
                <h4 class="card-title">Orders</h4>
                <p class="card-description">List of all orders</p>
                <div class="table-responsive">
                    <table class="table table-striped" id="orderTable">
                        <thead>
                            <tr>
                                <th>Order ID</th>
                                <th>User Name</th>
                                <th>Payment Method</th>
                                <th>Total Amount</th>
                                <th>Order Status</th>
                                <th>Order Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% orders.forEach((order) => { %>
                            <tr>
                                <td><%= order.orderId %></td>
                                <td><%= order.address.name %></td>
                                <td><%= order.paymentMethod %></td>
                                <td>$<%= order.totalAmount %></td>
                                <td><%= order.orderStatus %></td>
                                <td><%= new Date(order.orderDate).toLocaleDateString() %></td>
                                <td>
                                  
                                    <button class="btn btn-info btn-sm" onclick="toggleOrderDetails('<%= order._id %>')">View</button>
                                    <% if (!order.isCancelled){ %>
                                      <% if (!order.isApproved) { %>
                                        <button class="btn btn-warning btn-sm"  id="orderApproval" value="<%= order._id %>">Approve</button>
                                        <% } else { %>
                                      <button class="btn btn-success btn-sm" disabled>Approved</button>
                                      <% } %>
                                    <% } else { %>
                                      <p><strong style="color: red;"> Order Cancelled</strong></p>
                                    <% }%>
                                </td>
                            </tr>

                            <!-- Hidden Order Details (Initially hidden) -->
                            <tr id="order-<%= order._id %>" class="order-details d-none">
                                <td colspan="7">
                                    <!-- Product Details Section -->
                                    <% order.orderItem.forEach((items) => { %>
                                    <div class="order-item">
                                        <h6><strong>Product Name:</strong> <%= items.productName %></h6>
                                        <p><strong>Color:</strong> <%= items.color %></p>
                                        <p><strong>Quantity:</strong> <%= items.quantity %></p>
                                        <p><strong>Price:</strong> $<%= items.price %></p>
                                        <p><strong>Total Price:</strong> $<%= items.totalPrice %></p>
                                        <p><strong>Description:</strong></p>
                                        <p style="white-space: pre-wrap;"><%= items.description %></p>
                                        <p><strong>Status:</strong> <%= items.orderStatus %></p>
                                        <p><strong>Order Date:</strong> <%= new Date(order.orderDate).toLocaleDateString() %></p>
                                        <img src="<%= items.image %>" alt="Product Image" class="order-image" style="width: 100px; height: auto;">
                                        <% if (!order.isCancelled && !items.isCancelled){ %>
                                        <% if (order.isApproved) { %>
                                        <div class="product-action-buttons mt-2">
                                          <% if(items.orderStatus !== "Shipped" && items.orderStatus !== "Delivered" && items.orderStatus !== "Cancel") { %>
                                            <button class="btn btn-primary btn-sm" id="shipping" type="button" onclick='shipped("<%= items._id %>", "<%= order._id %>", "Shipped")'>Shipping</button>
                                        <% } %>
                                        <%if (items.orderStatus=="Shipped"){%>
                                          <button class="btn btn-success btn-sm" id="delivered" type="button" onclick='shipped("<%= items._id %>","<%=order._id%>","Delivered")'>Delivered</button>
                                        <%}%>
                                        <%if (items.orderStatus !="Delivered"){%>
                                          <button class="btn btn-danger btn-sm" id="cancel" type="button" onclick='shipped("<%= items._id %>","<%=order._id%>","Cancel")'>Cancel</button> 
                                          <%}%>                                         
                                        </div>
                                        <% } %>
                                        <% }%>
                                    </div>
                                    <hr>
                                    <% }) %>

                                    <div class="address-section mt-4">
                                        <h6><strong>Shipping Address:</strong></h6>
                                        <p><strong>Name:</strong> <%= order.address.name %></p>
                                        <p><strong>Email:</strong> <%= order.address.email %></p>
                                        <p><strong>Phone No:</strong> <%= order.address.phoneNo %></p>
                                        <p><strong>Street Address:</strong> <%= order.address.streetAddress %></p>
                                        <p><strong>City:</strong> <%= order.address.city %></p>
                                        <p><strong>District:</strong> <%= order.address.district %></p>
                                        <p><strong>Pincode:</strong> <%= order.address.pincode %></p>
                                    </div>
                                </td>
                            </tr>
                            <% }) %>
                        </tbody>
                    </table>
                </div>
                <nav aria-label="Page navigation">
                    <ul class="pagination justify-content-center">
                      <% if (currentPage > 1) { %>
                        <li class="page-item">
                          <a class="page-link" href="/admin/orders?page=<%= currentPage - 1 %>" aria-label="Previous">
                            <span aria-hidden="true">&laquo;</span>
                          </a>
                        </li>
                      <% } else { %>
                        <li class="page-item disabled">
                          <a class="page-link" href="#" aria-label="Previous">
                            <span aria-hidden="true">&laquo;</span>
                          </a>
                        </li>
                      <% } %>
                  
                      <% for (let i = 1; i <= totalPages; i++) { %>
                        <% if (i === currentPage) { %>
                          <li class="page-item active"><a class="page-link" href="#"><%= i %></a></li>
                        <% } else { %>
                          <li class="page-item"><a class="page-link" href="/admin/orders?page=<%= i %>"><%= i %></a></li>
                        <% } %>
                      <% } %>
                  
                      <% if (currentPage < totalPages) { %>
                        <li class="page-item">
                          <a class="page-link" href="/admin/orders?page=<%= currentPage + 1 %>" aria-label="Next">
                            <span aria-hidden="true">&raquo;</span>
                          </a>
                        </li>
                      <% } else { %>
                        <li class="page-item disabled">
                          <a class="page-link" href="#" aria-label="Next">
                            <span aria-hidden="true">&raquo;</span>
                          </a>
                        </li>
                      <% } %>
                    </ul>
                  </nav>                  
              
            </div>
        </div>
    </div>
</div>

<%- include('../layout/admin/adminFooter') -%>
<script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert/1.1.3/sweetalert.min.js"></script>

<script>
    function toggleOrderDetails(orderId) {
        const detailsRow = document.getElementById(`order-${orderId}`);
        detailsRow.classList.toggle('d-none');
    }

    document.getElementById("orderApproval").addEventListener('click', async (event) => {
    event.preventDefault();
      console.log("hi")
    const orderId = document.getElementById("orderApproval").value; 

    try {
        const response = await fetch("/admin/orderApproval", {
            method: "PATCH",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ orderId })
        });
        const data = await response.json()
        console.log(data)
        if(data.success){
          swal("Success!", "Order has been approved successfully!", "success");
        }
        setTimeout(()=>{
          window.location.reload()
        },1500)
    } catch (error) {
        console.error("Error approving order:", error);
    }
});

async function shipped(itemId,orderId,status){
 
  console.log(itemId);
  console.log(status)
  
  const response = await fetch('/admin/orderStatusEdit',{
    method:"PATCH",
    headers:{
      "Content-Type":"application/json"
    },
    body:JSON.stringify({itemId,status,orderId})
  })
  const data = await response.json()
  if(data.success){
    swal("Success!", "Order has been approved successfully!", "success");
    setTimeout(()=>{
      window.location.reload()
    },1500)
  }
}

  


</script>

<style>
    .d-none {
        display: none;
    }
</style>
