<%- include('../layout/admin/adminHeader') -%>
<%- include('../layout/admin/adminNavbar') -%>

<div class="main-panel">
  <div class="content-wrapper">
    <div class="page-header">
      <h3 class="page-title">User List</h3>
    </div>
    
    <div class="row">
      <div class="col-12 grid-margin stretch-card">
        <div class="card">
          <div class="card-body">
            <h4 class="card-title">Users</h4>
            <p class="card-description">List of all users</p>
            <div class="table-responsive">
                <table class="table table-striped" id="userTable">
                    <thead>
                      <tr>
                        <th>NO</th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>phone</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      
                    </tbody>
                  </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <%- include('../layout/admin/adminFooter') -%>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
  fetch('/admin/api/users')
    .then(response => response.json())
    .then(users => {
      const userTableBody = document.querySelector("#userTable tbody");
      
      let tableContent = '';

      users.forEach((user, index) => {
        let buttonLabel = user.isBlocked ? 'Unblock' : 'Block';
        let buttonClass = user.isBlocked ? 'btn-success' : 'btn-danger'; 
        
        tableContent += `
          <tr>
            <td>${index + 1}</td>
            <td>${user.name}</td>
            <td>${user.email}</td>
            <td>${user.phone}</td>
            <td>
                <a href="#" class="btn btn-dark btn-sm view-btn" data-id="${user._id}">View</a>
                <button class="btn ${buttonClass} btn-sm block-btn" data-id="${user._id}" data-action="${user.isBlocked ? 'unblock' : 'block'}">${buttonLabel}</button>
            </td>
          </tr>
        `;
      });

      userTableBody.innerHTML = tableContent;

      // Add event listener for block/unblock buttons
      document.querySelectorAll('.block-btn').forEach(button => {
        button.addEventListener('click', function() {
          const userId = this.dataset.id;
          const action = this.dataset.action;
          const button = this;

          Swal.fire({
            title: `Are you sure you want to ${action} this user?`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: `Yes, ${action} them!`
          }).then((result) => {
            if (result.isConfirmed) {
              // Send POST request to block/unblock user
              fetch(`/admin/block/${userId}`, {
                method: 'POST',
              })
              .then(response => response.json())
              .then(data => {
                if (data.success) {
                  Swal.fire(
                    'Success!',
                    `User has been ${action}ed.`,
                    'success'
                  );
                  // Update the button label and class
                  button.innerHTML = action === 'block' ? 'Unblock' : 'Block';
                  button.classList.toggle('btn-danger');
                  button.classList.toggle('btn-success');
                  button.dataset.action = action === 'block' ? 'unblock' : 'block';
                } else {
                  Swal.fire(
                    'Error!',
                    data.message || 'Something went wrong. Please try again later.',
                    'error'
                  );
                }
              })
              .catch((error) => {
                Swal.fire(
                  'Error!',
                  'Failed to perform action.',
                  'error'
                );
              });
            }
          });
        });
      });
    })
    .catch((error) => console.error('Error fetching users:', error));
});

    </script>
    